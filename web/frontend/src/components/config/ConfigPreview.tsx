import { Card, Descriptions, Space, Button, Typography, Tag, Divider } from 'antd';
import { DownloadOutlined, CopyOutlined } from '@ant-design/icons';
import { message } from 'antd';

const { Text, Paragraph } = Typography;

interface ConfigPreviewProps {
  config: {
    backbone: {
      type: string;
      pretrained: boolean;
      freeze_layers: number;
    };
    fusion: {
      strategy: string;
      hidden_dim?: number;
      num_heads?: number;
    };
    aggregator: {
      type: string;
      params?: Record<string, any>;
    };
    hyperparameters: {
      learning_rate: number;
      batch_size: number;
      epochs: number;
      optimizer: string;
      scheduler?: string;
      weight_decay: number;
    };
    training: {
      mixed_precision: boolean;
      gradient_accumulation_steps: number;
      early_stopping_patience: number;
    };
  };
  onExport: () => void;
}

export default function ConfigPreview({ config, onExport }: ConfigPreviewProps) {
  const handleCopyYAML = () => {
    const yaml = generateYAML(config);
    navigator.clipboard.writeText(yaml);
    message.success('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  };

  const generateYAML = (config: any): string => {
    return `# MedFusion Configuration
# Generated by Config Generator

model:
  backbone:
    type: ${config.backbone.type}
    pretrained: ${config.backbone.pretrained}
    freeze_layers: ${config.backbone.freeze_layers}

  fusion:
    strategy: ${config.fusion.strategy}
${config.fusion.hidden_dim ? `    hidden_dim: ${config.fusion.hidden_dim}` : ''}
${config.fusion.num_heads ? `    num_heads: ${config.fusion.num_heads}` : ''}

  aggregator:
    type: ${config.aggregator.type}
${config.aggregator.params?.hidden_dim ? `    hidden_dim: ${config.aggregator.params.hidden_dim}` : ''}
${config.aggregator.params?.num_heads ? `    num_heads: ${config.aggregator.params.num_heads}` : ''}

training:
  hyperparameters:
    learning_rate: ${config.hyperparameters.learning_rate}
    batch_size: ${config.hyperparameters.batch_size}
    epochs: ${config.hyperparameters.epochs}
    optimizer: ${config.hyperparameters.optimizer}
${config.hyperparameters.scheduler ? `    scheduler: ${config.hyperparameters.scheduler}` : ''}
    weight_decay: ${config.hyperparameters.weight_decay}

  mixed_precision: ${config.training.mixed_precision}
  gradient_accumulation_steps: ${config.training.gradient_accumulation_steps}
  early_stopping_patience: ${config.training.early_stopping_patience}
`;
  };

  return (
    <Space direction="vertical" size="large" style={{ width: '100%' }}>
      {/* é…ç½®æ€»è§ˆ */}
      <Card title="é…ç½®æ€»è§ˆ" size="small">
        <Descriptions column={2} bordered size="small">
          <Descriptions.Item label="Backbone">
            <Space>
              <Text strong>{config.backbone.type}</Text>
              {config.backbone.pretrained && <Tag color="blue">é¢„è®­ç»ƒ</Tag>}
              {config.backbone.freeze_layers > 0 && (
                <Tag color="orange">å†»ç»“ {config.backbone.freeze_layers} å±‚</Tag>
              )}
            </Space>
          </Descriptions.Item>

          <Descriptions.Item label="Fusion ç­–ç•¥">
            <Space>
              <Text strong>{config.fusion.strategy}</Text>
              {config.fusion.hidden_dim && (
                <Tag>dim: {config.fusion.hidden_dim}</Tag>
              )}
              {config.fusion.num_heads && (
                <Tag>heads: {config.fusion.num_heads}</Tag>
              )}
            </Space>
          </Descriptions.Item>

          <Descriptions.Item label="Aggregator">
            <Space>
              <Text strong>{config.aggregator.type}</Text>
              {config.aggregator.params?.hidden_dim && (
                <Tag>dim: {config.aggregator.params.hidden_dim}</Tag>
              )}
              {config.aggregator.params?.num_heads && (
                <Tag>heads: {config.aggregator.params.num_heads}</Tag>
              )}
            </Space>
          </Descriptions.Item>

          <Descriptions.Item label="ä¼˜åŒ–å™¨">
            <Text strong>{config.hyperparameters.optimizer.toUpperCase()}</Text>
          </Descriptions.Item>

          <Descriptions.Item label="å­¦ä¹ ç‡">
            {config.hyperparameters.learning_rate}
          </Descriptions.Item>

          <Descriptions.Item label="Batch Size">
            {config.hyperparameters.batch_size} Ã— {config.training.gradient_accumulation_steps} = {' '}
            <Text strong>{config.hyperparameters.batch_size * config.training.gradient_accumulation_steps}</Text>
            {' '}(ç­‰æ•ˆ)
          </Descriptions.Item>

          <Descriptions.Item label="è®­ç»ƒè½®æ•°">
            {config.hyperparameters.epochs}
          </Descriptions.Item>

          <Descriptions.Item label="æ—©åœè€å¿ƒå€¼">
            {config.training.early_stopping_patience}
          </Descriptions.Item>

          <Descriptions.Item label="æƒé‡è¡°å‡">
            {config.hyperparameters.weight_decay}
          </Descriptions.Item>

          <Descriptions.Item label="å­¦ä¹ ç‡è°ƒåº¦å™¨">
            {config.hyperparameters.scheduler || 'ä¸ä½¿ç”¨'}
          </Descriptions.Item>

          <Descriptions.Item label="æ··åˆç²¾åº¦">
            {config.training.mixed_precision ? (
              <Tag color="green">âœ… å¼€å¯</Tag>
            ) : (
              <Tag>âŒ å…³é—­</Tag>
            )}
          </Descriptions.Item>

          <Descriptions.Item label="æ¢¯åº¦ç´¯ç§¯">
            {config.training.gradient_accumulation_steps} æ­¥
          </Descriptions.Item>
        </Descriptions>
      </Card>

      <Divider />

      {/* YAML é¢„è§ˆ */}
      <Card
        title="YAML é…ç½®é¢„è§ˆ"
        size="small"
        extra={
          <Space>
            <Button
              icon={<CopyOutlined />}
              onClick={handleCopyYAML}
              size="small"
            >
              å¤åˆ¶
            </Button>
            <Button
              type="primary"
              icon={<DownloadOutlined />}
              onClick={onExport}
              size="small"
            >
              å¯¼å‡º
            </Button>
          </Space>
        }
      >
        <pre
          style={{
            backgroundColor: '#f5f5f5',
            padding: '16px',
            borderRadius: '4px',
            overflow: 'auto',
            maxHeight: '400px',
            fontSize: '12px',
            lineHeight: '1.6',
          }}
        >
          {generateYAML(config)}
        </pre>
      </Card>

      {/* ä½¿ç”¨æç¤º */}
      <Card size="small" style={{ backgroundColor: '#f0f5ff' }}>
        <Space direction="vertical" size="small">
          <Text strong>ğŸ’¡ ä½¿ç”¨æç¤º</Text>
          <Paragraph style={{ margin: 0, fontSize: '12px', color: '#666' }}>
            1. ç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ä¸‹è½½ YAML é…ç½®æ–‡ä»¶
          </Paragraph>
          <Paragraph style={{ margin: 0, fontSize: '12px', color: '#666' }}>
            2. ä½¿ç”¨ CLI å‘½ä»¤å¯åŠ¨è®­ç»ƒ: <Text code>medfusion train --config config.yaml</Text>
          </Paragraph>
          <Paragraph style={{ margin: 0, fontSize: '12px', color: '#666' }}>
            3. æˆ–ç‚¹å‡»"å¯åŠ¨è®­ç»ƒ"æŒ‰é’®ç›´æ¥åœ¨ Web UI ä¸­å¯åŠ¨
          </Paragraph>
        </Space>
      </Card>
    </Space>
  );
}
